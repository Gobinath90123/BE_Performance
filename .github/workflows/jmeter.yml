name: Run All JMeter Tests

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  jmeter-test:
    runs-on: windows-latest

    steps:
      # Step 1: Checkout repo
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Set up Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # Step 3: Install JMeter
      - name: Install JMeter
        run: |
          curl -L https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.zip -o jmeter.zip
          tar -xf jmeter.zip
          echo "${{ github.workspace }}\apache-jmeter-5.6.3\bin" >> $env:GITHUB_PATH

      # Step 4: Run all JMX test scripts
      - name: Run All JMeter Scripts
        run: |
          $timestamp = Get-Date -Format "yyyy-MM-dd_HHmmss"
          $jmxFiles = Get-ChildItem "JMX files" -Filter *.jmx
          
          foreach ($file in $jmxFiles) {
            $baseName = [System.IO.Path]::GetFileNameWithoutExtension($file.Name)
            $resultDir = "results/${baseName}_$timestamp"
            mkdir $resultDir | Out-Null

            jmeter -n -t "$($file.FullName)" `
                   -l "$resultDir/results.jtl" `
                   -e -o "$resultDir/html"
          }

      # Step 5: Upload all reports
      - name: Upload JMeter Reports
        uses: actions/upload-artifact@v4
        with:
          name: all-jmeter-reports
          path: results/
